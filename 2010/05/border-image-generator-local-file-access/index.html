<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>border-image-generator: Local File Access</title>
  <meta name="description" content="This article covers the techniques used to implement the local file access feature that is included, along with tiling support, alternate styling, and parame...">

  <link href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="/2010/05/border-image-generator-local-file-access/">
  <link rel="alternate" type="application/rss+xml" title="incaseofstairs" href="/feed.xml">
  
  
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-15628919-1', 'auto');
  ga('send', 'pageview');

</script>
  

  
</head>

  <body>
    <div class="mdl-layout__container">
      <div class="mdl-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header mdl-layout__header--waterfall" role="banner">
  <div class="mdl-layout__header-row centered-content"">
    
    <a class="mdl-layout__title" href="/">
      <img class="avatar" src="https://avatars3.githubusercontent.com/kpdecker?v=3&s=50" alt="kpdecker" srcset="https://avatars3.githubusercontent.com/kpdecker?v=3&s=50 1x, https://avatars3.githubusercontent.com/kpdecker?v=3&s=100 2x, https://avatars3.githubusercontent.com/kpdecker?v=3&s=150 3x, https://avatars3.githubusercontent.com/kpdecker?v=3&s=200 4x" width="50" height="50" data-proofer-ignore="true" />
    </a>
    
    <div class="mdl-layout-spacer"></div>

    <nav class="mdl-navigation">
  
    
    <a class="mdl-navigation__link" href="/">About</a>
  
    
    <a class="mdl-navigation__link" href="/blog">Blog</a>
  
    
    <a class="mdl-navigation__link" href="/resume">Resume</a>
  
</nav>

  </div>
</header>


        <main class="mdl-layout__content" aria-label="Content">
          <article class="post centered-content" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      border-image-generator: Local File Access
      <time datetime="2010-05-31T00:00:00-05:00" itemprop="datePublished" class="post-meta">
        
        May 31, 2010
      </time>
    </h1>
  </header>
  <hr />

  <div class="post-content" itemprop="articleBody">
    <p>This article covers the techniques used to implement the local file access feature that is included, along with tiling support, alternate styling, and parameter optimization, in the most recent push to <a href="http://border-image.com">border-image-generator</a>.</p>

<p>One of the biggest short comings that I felt like border-image-generator was that all files had to be posted on a HTTP server due to restrictions on the access to the <code class="highlighter-rouge">file://</code> protocol. In my personal workflow this was somewhat of a pain, so I set out to find a way around this issue.</p>

<p>During the design of this feature, I quickly decided that all data must remain on the client as I did not want to upgrade my hosting service to include more bandwidth, felt like responsiveness could be a concern, and do not want to tangle with the potentially messy privacy issues that could arrise from storing user generated images on my server.</p>

<p>While this sounded like a daunting task, it turns out that this was possible, in sufficiently advanced browsers, using a variety of HTML5 techniques, including <a href="http://en.wikipedia.org/wiki/Data_URI_scheme">Data URIs</a>, the <a href="http://www.w3.org/TR/FileAPI/">File API</a> and the <a href="http://www.w3.org/TR/webstorage/">Web Storage API</a>.</p>

<h3 id="display">Display</h3>

<p>The problem of displaying the image was the easiest to solve as all of the targeted browsers support data URIs as part of the <code class="highlighter-rouge">border-image</code> property. This allowed the application to generate URLs like the following</p>

<div class="language-css highlighter-rouge"><pre class="highlight"><code>    <span class="nt">border-width</span><span class="o">:</span> <span class="nt">46px</span><span class="o">;</span>
    <span class="nt">border-image</span><span class="o">:</span> <span class="nt">url</span><span class="o">(</span><span class="s1">"data:image/png;base64,iVBORw0KGgoAAA...."</span><span class="o">)</span> <span class="nt">46</span> <span class="nt">stretch</span><span class="o">;</span>
</code></pre>
</div>

<p>And operate as expected. Data URIs have been covered fairly extensively elsewhere, so I will leave this to the reader to investigate.</p>

<h3 id="reading">Reading</h3>

<p>With the actual display issue solvled, there was still the non-trivial issue of actually loading the content. My initial investigations involved Flash, which provides <a href="http://help.adobe.com/en_US/AS3LCR/Flash_10.0/flash/net/FileReference.html#load()">FileReference.load</a> API which allowing for this functionality, but under the version I was testing on this API is only usable if invoked in response to user input. Being a HTML guy and lacking functional knowledge of the Flash development process I quickly ruled this technique out.</p>

<p>Continuing my research I came across an <a href="https://developer.mozilla.org/en/Using_files_from_web_applications">article</a> on MDC that covered this exact use case, using the draft File API specification. This worked like a charm, even exposing the ability to read the image contents directly into a data URI.</p>

<p>The API is very clean for use cases such as this:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">loadFile</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FileReader</span><span class="p">();</span>
    <span class="nx">reader</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
         <span class="nx">updateImageURI</span><span class="p">(</span><span class="nx">file</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">reader</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
     <span class="p">};</span>
     <span class="nx">reader</span><span class="p">.</span><span class="nx">readAsDataURL</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Where the <code class="highlighter-rouge">file</code> variable above is a <code class="highlighter-rouge">File</code> object retrieved from a <code class="highlighter-rouge">&lt;input type="file"&gt;</code> or the <code class="highlighter-rouge">dataTransfer</code> object passed to the <code class="highlighter-rouge">drop</code> html event.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>        <span class="nx">$</span><span class="p">(</span><span class="s2">"body"</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"dragenter dragover"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// We have to cancel these events or we will not recieve the drop event</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
        <span class="p">});</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">"body"</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"drop"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
            <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
            <span class="kd">var</span> <span class="nx">dataTransfer</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">dataTransfer</span><span class="p">,</span>
                <span class="nx">file</span> <span class="o">=</span> <span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

            <span class="nx">loadFile</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
        <span class="p">});</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">"#localImage"</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s2">"change"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">files</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

            <span class="nx">loadFile</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
        <span class="p">});</span>
</code></pre>
</div>

<p>This unfortunately is not without itâ€™s issues. The File API is very much bleeding edge at this point and support is somewhat limited. As of this writing Firefox is the only browser which features this in production (Version 3.6). Support <a href="http://trac.webkit.org/changeset/59162">landed</a> in the WebKit trunk literally earlier this month and can be used in their nightlies, but so far has not made it into any production releases.</p>

<p>The site is currently designed to progressively enhance as it detects support for the File API, so no need to worry about being left out of the site as a whole if you are not on one of these browsers yet.</p>

<h3 id="history">History</h3>

<p>After loading the content using the File API, the original implementation utilized the same #hash storage method for the data URIs, but this proved to be problematic as these strings can become quite large and interacting with these URLs was unwieldily. Needing another data store and being forced to maintain a cache of all local images due to the security model employed by the File API, we were left the options of storing all data in Javascript space or using the new Web Storage APIs implemented as part of HTML5.</p>

<p>Examining both options it seemed the the best course was to utilize the <code class="highlighter-rouge">sessionStorage</code> object when available and fail over to the javascript data model when not.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>    <span class="c1">// Check for browser support of session storage and that it is accessible</span>
    <span class="c1">// This may be inaccessible under certain contexts such as file://</span>
    <span class="kd">function</span> <span class="nx">supportsSessionStorage</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">!!</span><span class="nb">window</span><span class="p">.</span><span class="nx">sessionStorage</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">localDataBinding</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">supportsSessionStorage</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// If they support FileReader they really should support storage... but who knows (With the exception of file://)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="na">storeImage</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                    <span class="kd">var</span> <span class="nx">entryId</span> <span class="o">=</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">sessionStorage</span><span class="p">[</span><span class="s2">"imageList-count"</span><span class="p">])</span><span class="o">||</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
                    <span class="nx">sessionStorage</span><span class="p">[</span><span class="s2">"imageList-count"</span><span class="p">]</span> <span class="o">=</span> <span class="nx">entryId</span><span class="p">;</span>
                    <span class="nx">sessionStorage</span><span class="p">[</span><span class="s2">"imageList-src-"</span> <span class="o">+</span> <span class="nx">entryId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">;</span>
                    <span class="nx">sessionStorage</span><span class="p">[</span><span class="s2">"imageList-display-"</span> <span class="o">+</span> <span class="nx">entryId</span><span class="p">]</span> <span class="o">=</span> <span class="nx">name</span><span class="p">;</span>
                    <span class="k">return</span> <span class="nx">entryId</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="na">getImage</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">entryId</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="p">{</span> <span class="na">src</span><span class="p">:</span> <span class="nx">sessionStorage</span><span class="p">[</span><span class="s2">"imageList-src-"</span> <span class="o">+</span> <span class="nx">entryId</span><span class="p">],</span> <span class="na">displayName</span><span class="p">:</span> <span class="nx">sessionStorage</span><span class="p">[</span><span class="s2">"imageList-display-"</span> <span class="o">+</span> <span class="nx">entryId</span><span class="p">]</span> <span class="p">};</span>
                <span class="p">}</span>
            <span class="p">};</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Fail over to plain js structures, meaing that refresh, etc will cause failures.</span>
            <span class="kd">var</span> <span class="nx">cache</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="na">storeImage</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">cache</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span> <span class="na">src</span><span class="p">:</span> <span class="nx">data</span><span class="p">,</span> <span class="na">displayName</span><span class="p">:</span> <span class="nx">name</span> <span class="p">});</span>
                    <span class="k">return</span> <span class="nx">cache</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
                <span class="p">},</span>
                <span class="na">getImage</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">entryId</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">return</span> <span class="nx">cache</span><span class="p">[</span><span class="nx">entryId</span><span class="p">];</span>
                <span class="p">}</span>
            <span class="p">};</span>
        <span class="p">}</span>
    <span class="p">})();</span>
</code></pre>
</div>

<p>Working with this API it seems as though it is still somewhat rough. The vendor documentation all state that supported datatypes are only string values (<a href="https://developer.mozilla.org/en/dom/storage">Mozilla</a>, <a href="http://developer.apple.com/safari/library/documentation/AppleApplications/Reference/WebKitDOMRef/Storage_idl/Classes/Storage/index.html">WebKit</a>), but the spec implies that this will change be final release and allow for storage of a much broader set of datatypes.</p>

<p>A consequence of this design is that boomark and URL sharing for local files is not a possibility. For users who need to share or store  application states the image in question will need to be stored on a HTTP server and accessed by this route.</p>

<p>These changes as well as some incremental changes have been pushed live on <a href="http://border-image.com">border-image.com</a> and are available in the github <a href="http://github.com/kpdecker/border-image-generator">repository</a>.</p>

  </div>

  


  <div class="post-navigation">
    
      <a href="/2010/06/implementation-facebook-for-webos-add-tag-ui/">&laquo; Implementation: Facebook for webOS Add Tag UI</a>
    
    
      <a href="/2010/05/javascript-operation-queue/">Javascript Operation Queue &raquo;</a>
    
  </div>
</article>

          <footer class="mdl-mini-footer">
  <div class="centered-content">
    <div class="footer-links">
      <ul class="contact-list">
        <li>
          
            Kevin Decker
          
          </li>
          
          <li><a href="mailto:kpdecker@gmail.com">kpdecker@gmail.com</a></li>
          
          
          <li><a href="https://kpdecker.github.io/resume/">Resume</a></li>
          
      </ul>

      <ul class="social-media-list">
        
        <li>
          <a href="https://github.com/kpdecker"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="32px" height="32px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg></span></a>
        </li>
        

        
        <li>
          <a href="https://twitter.com/kpdecker"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="32px" height="32px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg></span></a>
        </li>
        

        
        <li>
          <a href="https://linkedin.com/kpdecker"><span class="icon icon--linkedin"><svg viewBox="0 0 16 16" width="32px" height="32px"><path fill="rgb(130, 130, 130)" d="M1.7 0C.7 0 0 .7 0 1.6 0 2.4.7 3 1.7 3s1.8-.6 1.8-1.4C3.5.6 2.8 0 1.7 0zM0 15h3.4V4.3H0V15zM12.3 4.5c-1 0-2-.2-3.2 1.4V4H6v11h3.4V8c.3-.5 1-1 1.8-1 1.2 0 1.7.8 1.7 2v6h3V8.7c0-3-1.8-4.2-4-4.2z"/></svg></span></a>
        </li>
        
      </ul>

      <p>Personal musings on software engineering.</p>
    </div>
  </div>
</footer>
        </main>
      </div>
    </div>
  </body>
</html>
