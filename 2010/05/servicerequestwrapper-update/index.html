<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ServiceRequestWrapper Update</title>
  <meta name="description" content="This article is part of my Palm Dev Day summary series as well as a follow up to the original service request garbage collection post from last month.">

  <link href="https://fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://localhost:4000/2010/05/servicerequestwrapper-update/">
  <link rel="alternate" type="application/rss+xml" title="incaseofstairs" href="/feed.xml">
  
  
</head>

  <body>
    <div class="mdl-layout__container">
      <div class="mdl-layout mdl-layout--fixed-header">
        <header class="mdl-layout__header mdl-layout__header--waterfall" role="banner">
  <div class="mdl-layout__header-row centered-content"">
    
    <a class="mdl-layout__title" href="/">
      <img class="avatar" src="https://avatars3.githubusercontent.com/kpdecker?v=3&s=50" alt="kpdecker" srcset="https://avatars3.githubusercontent.com/kpdecker?v=3&s=50 1x, https://avatars3.githubusercontent.com/kpdecker?v=3&s=100 2x, https://avatars3.githubusercontent.com/kpdecker?v=3&s=150 3x, https://avatars3.githubusercontent.com/kpdecker?v=3&s=200 4x" width="50" height="50" data-proofer-ignore="true" />
    </a>
    
    <div class="mdl-layout-spacer"></div>

    <nav class="mdl-navigation">
  
    
    <a class="mdl-navigation__link" href="/">About</a>
  
    
    <a class="mdl-navigation__link" href="/blog">Blog</a>
  
    
    <a class="mdl-navigation__link" href="/resume">Resume</a>
  
</nav>

  </div>
</header>


        <main class="mdl-layout__content" aria-label="Content">
          <article class="post centered-content" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">
      ServiceRequestWrapper Update
      <time datetime="2010-05-04T00:00:00-05:00" itemprop="datePublished" class="post-meta">
        
        May 4, 2010
      </time>
    </h1>
  </header>
  <hr />

  <div class="post-content" itemprop="articleBody">
    <p>This article is part of my <a href="http://www.incaseofstairs.com/tag/palmdev/">Palm Dev Day</a> summary series as well as a follow up to the <a href="http://www.incaseofstairs.com/2010/04/garbage-collection-gotchas-in-webos/">original</a> service request garbage collection post from last month.</p>

<p>After reexamining the original <code class="highlighter-rouge">ServiceRequestWrapper</code> implementation and the possible use cases, some improvements began to show through:</p>

<ul>
  <li>Subscribe requests were not protected from garbage collection after the initial complete callback (Thanks to <a href="http://www.incaseofstairs.com/2010/04/garbage-collection-gotchas-in-webos/#comment-122">Johan</a> for pointing this out)</li>
  <li>Requests were not being automatically cancelled on completion</li>
  <li>The class did not need to be instantiatable as the 90% case can be handled by a singleton</li>
</ul>

<p>With these issues in mind I decided that a rewrite was in order to make the class easier to use, as this is what the goal was in the first place :).</p>

<h3 id="non-subscription-requests">Non-Subscription Requests</h3>

<p>Usage for non-subscription requests now involves a single call, <code class="highlighter-rouge">ServiceRequestWrapper.request</code> that is a “fire and forget” call meaning that cleanup is completely automated.</p>

<p>For example a call to determine the device ID can be done as follows:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code>    <span class="nx">ServiceRequestWrapper</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">'palm://com.palm.preferences/systemProperties'</span><span class="p">,</span> <span class="p">{</span>
            <span class="na">method</span><span class="p">:</span><span class="s2">"Get"</span><span class="p">,</span>
            <span class="na">parameters</span><span class="p">:{</span><span class="s2">"key"</span><span class="p">:</span> <span class="s2">"com.palm.properties.nduid"</span> <span class="p">},</span>
            <span class="na">onSuccess</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">Mojo</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Device ID: %j"</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
            <span class="p">}</span>
      <span class="p">});</span>
</code></pre>
</div>

<p>Note that are no special requirements to cleanup the request object for these types of calls. Upon completion the request object will be cleaned from both the <code class="highlighter-rouge">ServiceRequestWrapper</code> data structures as well as any system level data structures.</p>

<h3 id="subscription-requests">Subscription Requests</h3>

<p>The subscription case is not as simple as the framework can not reliably determine when the request is complete and future results are no longer desired. In order to reliably cleanup subscription requests <code class="highlighter-rouge">ServiceRequestWrapper</code> places the cleanup responsibility on the caller, via the <code class="highlighter-rouge">cancel</code> method, much in the same way as the <a href="http://developer.palm.com/index.php?option=com_content&amp;view=article&amp;id=1867&amp;Itemid=256">Mojo.Service.Request</a> API.</p>

<p>In practice this is not much harder than dealing with the single case. The following example monitors the system preferences for two changes to an arbitrary preference and then cancels any further action on that subscription.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">ServiceRequestWrapper</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">'palm://com.palm.systemservice'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">method</span><span class="p">:</span><span class="s2">"getPreferences"</span><span class="p">,</span>
    <span class="na">parameters</span><span class="p">:{</span> <span class="na">keys</span><span class="p">:</span> <span class="p">[</span> <span class="s2">"food"</span> <span class="p">],</span> <span class="na">subscribe</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">onSuccess</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Mojo</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Preference changed: %j"</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
        <span class="nx">count</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">count</span> <span class="o">===</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">request</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The <code class="highlighter-rouge">request</code> API also returns the a request object, which is identical to the 2nd parameter passed to callbacks, for those that need to cancel the request outside of the scope of a callback.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">subsRequest</span> <span class="o">=</span> <span class="nx">ServiceRequestWrapper</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">'palm://com.palm.systemservice'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">method</span><span class="p">:</span><span class="s2">"getPreferences"</span><span class="p">,</span>
    <span class="na">parameters</span><span class="p">:{</span> <span class="na">keys</span><span class="p">:</span> <span class="p">[</span> <span class="s2">"food"</span> <span class="p">],</span> <span class="na">subscribe</span><span class="p">:</span> <span class="kc">true</span> <span class="p">},</span>
    <span class="na">onSuccess</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">,</span> <span class="nx">request</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">Mojo</span><span class="p">.</span><span class="nx">Log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s2">"Preference changed: %j"</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="c1">// And then a miracle occurs</span>

<span class="nx">subRequest</span><span class="p">.</span><span class="nx">cancel</span><span class="p">();</span>
</code></pre>
</div>

<h3 id="source">Source</h3>

<p>The updated library is available on github in the <a href="http://github.com/palm/webos-samples/tree/master/tipsAndTricks/service-request-wrapper/">palm/webos-samples</a> repository.</p>

  </div>

  


  <div class="post-navigation">
    
      <a href="/2010/05/facebook-for-webos-seed-status/">&laquo; Facebook for webOS: Seed Status</a>
    
    
      <a href="/2010/04/palm-dev-day-adventures-in-facebook/">Palm Dev Day: Adventures in Facebook &raquo;</a>
    
  </div>
</article>

          <footer class="mdl-mini-footer">
  <div class="centered-content">
    <div class="footer-links">
      <ul class="contact-list">
        <li>
          
            Kevin Decker
          
          </li>
          
          <li><a href="mailto:kpdecker@gmail.com">kpdecker@gmail.com</a></li>
          
          
          <li><a href="https://kpdecker.github.io/resume/">Resume</a></li>
          
      </ul>

      <ul class="social-media-list">
        
        <li>
          <a href="https://github.com/kpdecker"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="32px" height="32px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg></span></a>
        </li>
        

        
        <li>
          <a href="https://twitter.com/kpdecker"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="32px" height="32px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg></span></a>
        </li>
        

        
        <li>
          <a href="https://linkedin.com/kpdecker"><span class="icon icon--linkedin"><svg viewBox="0 0 16 16" width="32px" height="32px"><path fill="rgb(130, 130, 130)" d="M1.7 0C.7 0 0 .7 0 1.6 0 2.4.7 3 1.7 3s1.8-.6 1.8-1.4C3.5.6 2.8 0 1.7 0zM0 15h3.4V4.3H0V15zM12.3 4.5c-1 0-2-.2-3.2 1.4V4H6v11h3.4V8c.3-.5 1-1 1.8-1 1.2 0 1.7.8 1.7 2v6h3V8.7c0-3-1.8-4.2-4-4.2z"/></svg></span></a>
        </li>
        
      </ul>

      <p>Personal musings on software engineering.</p>
    </div>
  </div>
</footer>
        </main>
      </div>
    </div>
  </body>
</html>
